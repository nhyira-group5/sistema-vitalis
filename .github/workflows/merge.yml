name: PR da Branch de Developer para Main

on:
  push:
    branches:
      - Developer

permissions:
  contents: write
  pull-requests: write

jobs:
  check_and_open_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch main branch
        run: |
          git fetch origin main:main

      - name: Check for merge conflicts
        id: merge_check
        run: |
          # Tenta fazer o merge da branch Developer na main para verificar conflitos
          if ! git merge --no-commit --no-ff main --allow-unrelated-histories; then
            echo "conflict=true" >> $GITHUB_ENV
            # Não faz o git merge --abort aqui, pois o merge não foi iniciado
          else
            echo "conflict=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.conflict == 'false'
        uses: peter-evans/create-pull-request@v3
        id: create_pr
        with:
          title: 'Automated Pull Request'
          body: |
            This pull request is automatically created from the Developer branch.
          base: main
          head: Developer

      - name: Comment on PR
        if: env.conflict == 'false'
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ steps.create_pr.outputs.pull-request-number }}
          body: |
            ### Automated PR Details
            - **Branch**: `Developer`
            - **Base Branch**: `main`
            - **Latest Commit**: `${{ github.sha }}`
            - **Linting**: ✅ Passed
            - **Tests**: ✅ Passed
